name: Run Tests

on:
  push:
    branches: [ "master", "main", "scenario/*", "eval/*", "feature/*" ]
  pull_request:
    branches: [ "master", "main", "scenario/*", "eval/*", "feature/*" ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Create placeholder issue comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create placeholder issue comment
        id: create_comment
        uses: actions/github-script@v7
        env:
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const issuePat = /#(\d+)/g;
            let issueNum = null, m;
            if (context.payload.pull_request) {
              const whole = `${context.payload.pull_request.title}\n${context.payload.pull_request.body}`;
              if ((m = issuePat.exec(whole)) !== null) issueNum = +m[1];
            }
            if (!issueNum && context.payload.commits) {
              for (const c of context.payload.commits) {
                if ((m = issuePat.exec(c.message)) !== null) { issueNum = +m[1]; break; }
              }
            }
            if (!issueNum) { core.info('No #issue reference found.'); return; }
            const body = `â³ **[${process.env.GITHUB_WORKFLOW}](${process.env.RUN_URL})** has **started**â€¦`;
            const { data: comment } = await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              issue_number: issueNum,
              body
            });
            core.setOutput('comment_id', comment.id.toString());

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Set up Python & install deps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. Set up Django environment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Django env (migrate, etc.)
#        env:
#          DJANGO_SETTINGS_MODULE: myproject.settings  # change as needed
        run: |
          python manage.py migrate
#           optionally create test db or collectstatic, if needed

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. Extract targeted test names â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Extract test names
        id: extract_tests
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const grab = (txt, re) => [...txt.matchAll(re)].flatMap(m => m[1].split(/[ ,]+/));
            const uniq = a => [...new Set(a.filter(Boolean))];
            let blocks = [];
            if (context.eventName === 'pull_request') {
              blocks = [`${context.payload.pull_request.title}\n${context.payload.pull_request.body}`];
            } else if (context.eventName === 'push') {
              blocks = context.payload.commits.map(c => c.message);
            }
            const fail = blocks.flatMap(b => grab(b, /FAIL_TO_PASS:\s*([^\n]+)/gi));
            const pass = blocks.flatMap(b => grab(b, /PASS_TO_PASS:\s*([^\n]+)/gi));
            const tests = uniq([...fail, ...pass]).join(',');
            core.setOutput('tests', tests);

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. Run selected tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run selected Django tests
        if: ${{ steps.extract_tests.outputs.tests }}
#        env:
#          DJANGO_SETTINGS_MODULE: myproject.settings  # change as needed
        run: |
          python manage.py test ${{ steps.extract_tests.outputs.tests }}

      - name: Run all Django tests
        if: ${{ steps.extract_tests.outputs.tests == '' }}
#        env:
#          DJANGO_SETTINGS_MODULE: myproject.settings  # change as needed
        run: |
          python manage.py test

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7. Update issue comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Update issue comment with final status
        if: always()
        uses: actions/github-script@v7
        env:
          COMMENT_ID: ${{ steps.create_comment.outputs.comment_id }}
          RUN_URL:    ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          JOB_STATUS: ${{ job.status }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            if (!process.env.COMMENT_ID) {
              core.info('No comment to update.'); return;
            }
            const statusEmoji = {
              success: 'âœ…',
              failure: 'âŒ',
              cancelled: 'ğŸŸ¡'
            }[process.env.JOB_STATUS] || 'ğŸŸ¡';
            const body = `${statusEmoji} **[${process.env.GITHUB_WORKFLOW}](${process.env.RUN_URL})** finished with status **${process.env.JOB_STATUS.toUpperCase()}**.`;
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              comment_id: Number(process.env.COMMENT_ID),
              body
            });
